<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPTV плеер</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>IPTV плеер</h1>
            <div class="stats-container">
                <div class="stat-item" title="Количество каналов">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm3.757-11.243a.5.5 0 0 1 0 .707L6.354 9.757a.5.5 0 0 1-.708-.708l5.364-5.364a.5.5 0 0 1 .707 0z"/>
                    </svg>
                    <span>Каналов:</span> <span id="channelCount">0</span>
                </div>
                <div class="stat-item" title="Время последнего обновления">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                    </svg>
                    <span>Обновлено:</span> <span id="lastUpdate">--:--</span>
                </div>
                <button id="refreshBtn" class="refresh-btn" title="Обновить список каналов">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                        <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
                    </svg>
                    <span class="btn-text">Обновить</span>
                </button>
            </div>
        </header>

        <div class="sidebar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Поиск каналов...">
            </div>
            <select id="categorySelect" title="Выбрать категорию">
                <option value="all">Все категории</option>
            </select>
            <button id="toggleSidebarBtn" class="toggle-sidebar-btn" title="Скрыть/показать панель">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                </svg>
            </button>
            <ul class="channel-list" id="channelList"></ul>
        </div>

        <div class="content">
            <div class="channel-info" id="channelInfo">
                <div class="channel-info-logo" id="channelInfoLogo"></div>
                <div class="channel-info-details">
                    <h2 class="channel-info-name" id="channelInfoName">Выберите канал</h2>
                    <div class="channel-info-group" id="channelInfoGroup"></div>
                </div>
                <button id="showSidebarBtn" class="show-sidebar-btn" title="Показать список каналов">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                </button>
            </div>
            
            <div class="player-container">
                <video id="player" controls autoplay></video>
                <div id="loadingIndicator">
                    <div class="spinner"></div>
                    <div>Загрузка трансляции...</div>
                </div>
                <div id="errorMessage" class="error-message">
                    Не удалось загрузить канал. Попробуйте другой.
                </div>
                <button id="exitFullscreenBtn" class="fullscreen-exit-button" title="Выйти из полноэкранного режима">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5zM0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zm10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4z"/>
                    </svg>
                </button>
            </div>

            <div class="player-controls">
                <button id="playPauseBtn" title="Воспроизведение/Пауза">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                    </svg>
                    <span class="btn-text">Воспроизвести</span>
                </button>
                <button id="stopBtn" title="Остановить">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/>
                    </svg>
                    <span class="btn-text">Стоп</span>
                </button>
                <button id="muteBtn" title="Включить/выключить звук">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/>
                        <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/>
                        <path d="M10.025 8a4.486 4.486 0 0 1-1.318 3.182L8 10.475A3.489 3.489 0 0 0 9.025 8c0-.966-.392-1.841-1.025-2.475l.707-.707A4.486 4.486 0 0 1 10.025 8zM7 4a.5.5 0 0 0-.812-.39L3.825 5.5H1.5A.5.5 0 0 0 1 6v4a.5.5 0 0 0 .5.5h2.325l2.363 1.89A.5.5 0 0 0 7 12V4zM4.312 6.39 6 5.04v5.92L4.312 9.61A.5.5 0 0 0 4 9.5H2v-3h2a.5.5 0 0 0 .312-.11z"/>
                    </svg>
                    <span class="btn-text">Без звука</span>
                </button>
                <button id="fullscreenBtn" title="Полноэкранный режим">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                    <span class="btn-text">На весь экран</span>
                </button>
                <select id="qualitySelect" title="Выбрать качество видео">
                    <option value="auto">Авто</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const player = document.getElementById('player');
            const channelList = document.getElementById('channelList');
            const searchInput = document.getElementById('searchInput');
            const categorySelect = document.getElementById('categorySelect');
            const channelCount = document.getElementById('channelCount');
            const lastUpdate = document.getElementById('lastUpdate');
            const refreshBtn = document.getElementById('refreshBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const channelInfoName = document.getElementById('channelInfoName');
            const channelInfoGroup = document.getElementById('channelInfoGroup');
            const channelInfoLogo = document.getElementById('channelInfoLogo');
            const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
            const sidebar = document.querySelector('.sidebar');
            
            // Кнопки управления плеером
            const playPauseBtn = document.getElementById('playPauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            const muteBtn = document.getElementById('muteBtn');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');
            const qualitySelect = document.getElementById('qualitySelect');
            const showSidebarBtn = document.getElementById('showSidebarBtn');
            
            let channels = [];
            let categories = new Set();
            let currentChannel = null;
            let currentHls = null; // Для хранения текущего экземпляра HLS.js
            
            // Инициализация UI состояния
            loadingIndicator.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Добавляем обработчики событий на плеер
            player.addEventListener('playing', () => {
                loadingIndicator.style.display = 'none';
                playPauseBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>
                    </svg>
                    <span class="btn-text">Пауза</span>
                `;
                playPauseBtn.title = "Пауза";
            });
            
            player.addEventListener('pause', () => {
                playPauseBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                    </svg>
                    <span class="btn-text">Воспроизвести</span>
                `;
                playPauseBtn.title = "Воспроизвести";
            });
            
            player.addEventListener('error', () => {
                loadingIndicator.style.display = 'none';
                errorMessage.style.display = 'flex';
                console.error('Ошибка HTML5 плеера:', player.error);
            });
            
            // Управление отображением текста на кнопках для мобильных устройств
            function updateButtonTextVisibility() {
                const isMobile = window.innerWidth <= 768;
                const btnTexts = document.querySelectorAll('.btn-text');
                
                btnTexts.forEach(text => {
                    text.style.display = isMobile ? 'none' : 'inline';
                });
            }
            
            // Переключение видимости боковой панели
            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('hidden');
            });
            
            // Вызываем при загрузке и изменении размера окна
            window.addEventListener('resize', updateButtonTextVisibility);
            updateButtonTextVisibility();
            
            // Автоматически скрываем сайдбар при выборе канала на мобильных устройствах
            function hideSidebarOnMobile() {
                if (window.innerWidth <= 768) {
                    sidebar.classList.add('hidden');
                }
            }
            
            // Загрузка списка каналов
            async function fetchChannels() {
                refreshBtn.disabled = true;
                try {
                    const response = await fetch('/api/channels');
                    if (!response.ok) {
                        throw new Error('Ошибка при загрузке каналов');
                    }
                    
                    const data = await response.json();
                    channels = data.channels;
                    categories.clear();
                    
                    // Обновляем информацию о списке каналов
                    channelCount.textContent = channels.length;
                    lastUpdate.textContent = new Date(data.last_update * 1000).toLocaleTimeString();
                    
                    // Собираем категории
                    channels.forEach(channel => {
                        if (channel.group) {
                            categories.add(channel.group);
                        }
                    });
                    
                    updateCategorySelect();
                    renderChannelList();
                    
                    return data; // Возвращаем данные для поддержки Promise chain
                } catch (error) {
                    console.error('Ошибка загрузки каналов:', error);
                    alert('Не удалось загрузить список каналов');
                    return null;
                } finally {
                    refreshBtn.disabled = false;
                }
            }
            
            // Обновление выпадающего списка категорий
            function updateCategorySelect() {
                categorySelect.innerHTML = '<option value="all">Все категории</option>';
                
                const sortedCategories = Array.from(categories).sort();
                sortedCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }
            
            // Отображение списка каналов
            function renderChannelList() {
                channelList.innerHTML = '';
                
                const searchText = searchInput.value.toLowerCase();
                const selectedCategory = categorySelect.value;
                
                const filteredChannels = channels.filter(channel => {
                    const matchesSearch = channel.name.toLowerCase().includes(searchText);
                    const matchesCategory = selectedCategory === 'all' || channel.group === selectedCategory;
                    return matchesSearch && matchesCategory;
                });
                
                filteredChannels.forEach(channel => {
                    const li = document.createElement('li');
                    li.className = 'channel-item';
                    li.dataset.id = channel.id;
                    li.title = channel.name;
                    
                    const logoDiv = document.createElement('div');
                    logoDiv.className = 'channel-logo';
                    
                    if (channel.logo) {
                        const img = document.createElement('img');
                        img.src = channel.logo;
                        img.alt = channel.name;
                        img.onerror = function() {
                            this.style.display = 'none';
                            logoDiv.textContent = channel.name.charAt(0);
                            logoDiv.classList.add('default');
                        };
                        logoDiv.appendChild(img);
                    } else {
                        logoDiv.textContent = channel.name.charAt(0);
                        logoDiv.classList.add('default');
                    }
                    
                    const textDiv = document.createElement('div');
                    textDiv.className = 'channel-text';
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'channel-name';
                    nameDiv.textContent = channel.name;
                    
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'channel-group';
                    groupDiv.textContent = channel.group || 'Без категории';
                    
                    textDiv.appendChild(nameDiv);
                    textDiv.appendChild(groupDiv);
                    
                    li.appendChild(logoDiv);
                    li.appendChild(textDiv);
                    
                    li.addEventListener('click', () => {
                        playChannel(channel);
                        hideSidebarOnMobile();
                    });
                    
                    channelList.appendChild(li);
                });
            }
            
            // Воспроизведение канала
            function playChannel(channel) {
                // Показываем индикатор загрузки и скрываем сообщение об ошибке
                loadingIndicator.style.display = 'flex';
                errorMessage.style.display = 'none';
                
                // Уничтожить предыдущий экземпляр HLS, если он существует
                if (currentHls) {
                    currentHls.destroy();
                    currentHls = null;
                }
                
                currentChannel = channel;
                
                // Обновляем информацию о текущем канале
                channelInfoName.textContent = channel.name;
                channelInfoGroup.textContent = channel.group || 'Без категории';
                
                // Обновляем логотип канала
                channelInfoLogo.innerHTML = '';
                if (channel.logo) {
                    const img = document.createElement('img');
                    img.src = channel.logo;
                    img.alt = channel.name;
                    img.onerror = function() {
                        this.style.display = 'none';
                        channelInfoLogo.textContent = channel.name.charAt(0);
                        channelInfoLogo.classList.add('default');
                    };
                    channelInfoLogo.appendChild(img);
                } else {
                    channelInfoLogo.textContent = channel.name.charAt(0);
                    channelInfoLogo.classList.add('default');
                }
                
                // Если HLS.js поддерживается
                if (Hls.isSupported()) {
                    const hls = new Hls({
                        maxBufferLength: 30,
                        maxMaxBufferLength: 60
                    });
                    
                    hls.loadSource(`/api/stream/${channel.id}`);
                    hls.attachMedia(player);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        player.play().catch(e => {
                            console.error('Ошибка автовоспроизведения:', e);
                        });
                    });
                    
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        if (data.fatal) {
                            console.error('Фатальная ошибка HLS:', data);
                            errorMessage.style.display = 'flex';
                            loadingIndicator.style.display = 'none';
                        }
                    });
                    
                    // Сохраняем экземпляр для последующего уничтожения
                    currentHls = hls;
                }
                // Для встроенной поддержки HLS (Safari)
                else if (player.canPlayType('application/vnd.apple.mpegurl')) {
                    player.src = `/api/stream/${channel.id}`;
                    player.addEventListener('loadedmetadata', function() {
                        player.play().catch(e => {
                            console.error('Ошибка автовоспроизведения:', e);
                        });
                    });
                    
                    player.addEventListener('error', function() {
                        console.error('Ошибка воспроизведения видео');
                        errorMessage.style.display = 'flex';
                        loadingIndicator.style.display = 'none';
                    });
                } else {
                    console.error('HLS не поддерживается в этом браузере');
                    errorMessage.style.display = 'flex';
                    loadingIndicator.style.display = 'none';
                }
                
                // Сохраняем последний канал в localStorage
                localStorage.setItem('lastChannel', JSON.stringify(channel));
            }
            
            // Обработчики кнопок управления
            playPauseBtn.addEventListener('click', () => {
                if (player.paused) {
                    player.play().then(() => {
                        playPauseBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>
                            </svg>
                            <span class="btn-text">Пауза</span>
                        `;
                        playPauseBtn.title = "Пауза";
                    }).catch(e => {
                        console.error('Ошибка воспроизведения:', e);
                    });
                } else {
                    player.pause();
                    playPauseBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                        </svg>
                        <span class="btn-text">Воспроизвести</span>
                    `;
                    playPauseBtn.title = "Воспроизвести";
                }
            });
            
            stopBtn.addEventListener('click', () => {
                if (player) {
                    player.pause();
                    player.currentTime = 0;
                    
                    // Уничтожаем экземпляр HLS для полной остановки потока
                    if (currentHls) {
                        currentHls.destroy();
                        currentHls = null;
                    }
                    
                    // Очищаем источник для полного сброса
                    player.removeAttribute('src');
                    player.load();
                    
                    // Скрываем загрузчик и сообщение об ошибке
                    loadingIndicator.style.display = 'none';
                    errorMessage.style.display = 'none';
                    
                    // Отображаем состояние плеера
                    playPauseBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                        </svg>
                        <span class="btn-text">Воспроизвести</span>
                    `;
                    playPauseBtn.title = "Воспроизвести";
                }
            });
            
            muteBtn.addEventListener('click', () => {
                player.muted = !player.muted;
                
                if (player.muted) {
                    muteBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06zM6 5.04 4.312 6.39A.5.5 0 0 1 4 6.5H2v3h2a.5.5 0 0 1 .312.11L6 10.96V5.04zm7.854.606a.5.5 0 0 1 0 .708L12.207 8l1.647 1.646a.5.5 0 0 1-.708.708L11.5 8.707l-1.646 1.647a.5.5 0 0 1-.708-.708L10.793 8 9.146 6.354a.5.5 0 1 1 .708-.708L11.5 7.293l1.646-1.647a.5.5 0 0 1 .708 0z"/>
                        </svg>
                        <span class="btn-text">Включить звук</span>
                    `;
                    muteBtn.title = "Включить звук";
                } else {
                    muteBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/>
                            <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/>
                            <path d="M10.025 8a4.486 4.486 0 0 1-1.318 3.182L8 10.475A3.489 3.489 0 0 0 9.025 8c0-.966-.392-1.841-1.025-2.475l.707-.707A4.486 4.486 0 0 1 10.025 8zM7 4a.5.5 0 0 0-.812-.39L3.825 5.5H1.5A.5.5 0 0 0 1 6v4a.5.5 0 0 0 .5.5h2.325l2.363 1.89A.5.5 0 0 0 7 12V4zM4.312 6.39 6 5.04v5.92L4.312 9.61A.5.5 0 0 0 4 9.5H2v-3h2a.5.5 0 0 0 .312-.11z"/>
                        </svg>
                        <span class="btn-text">Без звука</span>
                    `;
                    muteBtn.title = "Выключить звук";
                }
            });
            
            // Обработка двойного нажатия на плеер для полноэкранного режима
            const playerContainer = document.querySelector('.player-container');
            player.addEventListener('dblclick', () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(err => {
                        console.error('Ошибка выхода из полноэкранного режима:', err);
                    });
                } else {
                    playerContainer.requestFullscreen().catch(err => {
                        console.error('Ошибка перехода в полноэкранный режим:', err);
                    });
                }
            });
            
            // Фильтрация каналов
            searchInput.addEventListener('input', renderChannelList);
            categorySelect.addEventListener('change', renderChannelList);
            
            // Обновление списка каналов с визуальной обратной связью
            refreshBtn.addEventListener('click', async () => {
                // Добавляем класс с анимацией вращения
                refreshBtn.classList.add('refreshing');
                
                // Показываем уведомление о процессе обновления
                const oldText = refreshBtn.querySelector('.btn-text').textContent;
                refreshBtn.querySelector('.btn-text').textContent = 'Обновляю...';
                
                // Сохраняем старые значения для сравнения
                const oldCount = channelCount.textContent;
                const oldTime = lastUpdate.textContent;
                
                try {
                    // Выполняем обновление
                    const result = await fetch('/refresh-playlist', { method: 'GET' });
                    if (!result.ok) {
                        throw new Error('Ошибка обновления плейлиста');
                    }
                    
                    // После обновления плейлиста загружаем каналы
                    const data = await fetchChannels();
                    
                    // Отображаем оповещение об успешном обновлении
                    if (oldCount !== channelCount.textContent || oldTime !== lastUpdate.textContent) {
                        // Подсвечиваем изменения
                        channelCount.classList.add('updated');
                        lastUpdate.classList.add('updated');
                        
                        // Убираем подсветку через 2 секунды
                        setTimeout(() => {
                            channelCount.classList.remove('updated');
                            lastUpdate.classList.remove('updated');
                        }, 2000);
                        
                        // Показываем успешное обновление
                        refreshBtn.querySelector('.btn-text').textContent = 'Обновлено!';
                        setTimeout(() => {
                            refreshBtn.querySelector('.btn-text').textContent = oldText;
                        }, 1500);
                    } else {
                        refreshBtn.querySelector('.btn-text').textContent = 'Без изменений';
                        setTimeout(() => {
                            refreshBtn.querySelector('.btn-text').textContent = oldText;
                        }, 1500);
                    }
                } catch (error) {
                    console.error('Ошибка обновления:', error);
                    refreshBtn.querySelector('.btn-text').textContent = 'Ошибка';
                    setTimeout(() => {
                        refreshBtn.querySelector('.btn-text').textContent = oldText;
                    }, 1500);
                } finally {
                    // Убираем класс с анимацией вращения
                    setTimeout(() => {
                        refreshBtn.classList.remove('refreshing');
                    }, 500);
                }
            });
            
            // Прикрепляем к событию нажатия на кнопку Escape закрытие сайдбара
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && window.innerWidth <= 768) {
                    sidebar.classList.add('hidden');
                }
            });
            
            // Загружаем каналы при запуске
            fetchChannels();

            // Можно добавить отображение последнего канала без воспроизведения
            const lastChannelData = localStorage.getItem('lastChannel');
            if (lastChannelData) {
                try {
                    const lastChannel = JSON.parse(lastChannelData);
                    // Ищем канал с таким же id в загруженном списке
                    const savedChannel = channels.find(ch => ch.id === lastChannel.id);
                    if (savedChannel) {
                        console.log('Найден последний канал:', savedChannel.name);
                        // Только обновляем информацию о канале без воспроизведения
                        channelInfoName.textContent = savedChannel.name;
                        channelInfoGroup.textContent = savedChannel.group || 'Без категории';
                        
                        // Обновляем логотип канала
                        channelInfoLogo.innerHTML = '';
                        if (savedChannel.logo) {
                            const img = document.createElement('img');
                            img.src = savedChannel.logo;
                            img.alt = savedChannel.name;
                            img.onerror = function() {
                                this.style.display = 'none';
                                channelInfoLogo.textContent = savedChannel.name.charAt(0);
                                channelInfoLogo.classList.add('default');
                            };
                            channelInfoLogo.appendChild(img);
                        } else {
                            channelInfoLogo.textContent = savedChannel.name.charAt(0);
                            channelInfoLogo.classList.add('default');
                        }
                        
                        // Сохраняем текущий канал
                        currentChannel = savedChannel;
                    }
                } catch (e) {
                    console.error('Ошибка при загрузке последнего канала:', e);
                }
            }

            // Обработчик для дополнительной кнопки выхода из полноэкранного режима
            exitFullscreenBtn.addEventListener('click', () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(err => {
                        console.error('Ошибка выхода из полноэкранного режима:', err);
                    });
                }
            });

            // Обновляем обработчик полноэкранного режима
            fullscreenBtn.addEventListener('click', () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(err => {
                        console.error('Ошибка выхода из полноэкранного режима:', err);
                    });
                } else {
                    const playerContainer = document.querySelector('.player-container');
                    playerContainer.requestFullscreen().catch(err => {
                        console.error('Ошибка перехода в полноэкранный режим:', err);
                    });
                }
            });

            // Обработчики для кнопок показа панели с каналами
            showSidebarBtn.addEventListener('click', () => {
                sidebar.classList.remove('hidden');
            });
        });
    </script>
</body>
</html>
